<?php
if(! defined('ABSPATH')){
	exit;
}

	   function gigabyte_slide_shortcode($atts){
	    extract( shortcode_atts( array(
	        'count' => -1,
	        'loop' => 'true',
	        'slider_id' => '',
	        'height' => 480,
	        'autoplay' => 'false',
	        'autoplayTimeout' => 5000,
	        'nav' => 'true',
	        'dots' => 'false',
	    ), $atts) );
	     
	         
	     if($count == 1){
	        $q = new WP_Query(array('posts_per_page' => $count, 'post_type' => 'slide', 'p' => $slider_id,));   
	    }else{
	        $q = new WP_Query(array('posts_per_page' => $count, 'post_type' => 'slide', ));   
	    }
      
	    $gigabyte_slides_random_id = rand(3298702, 5497022);
	    if($count == 1){
           $gigabyte_slide_markup ='';
       }else{
	     $gigabyte_slide_markup ='
	        <script>
             jQuery(window).load(function(){
                jQuery("#gigabyte-slide-carousel-'.esc_attr($gigabyte_slides_random_id).'").owlCarousel({
                    loop: '.$loop.',
                     autoplay: '.$autoplay.',
                     autoplayTimeout: '.$autoplayTimeout.',
                     nav:'.$nav.',
                     dots: '.$dots.',
                     items: 1,
                     navText: ["<i class=\'fa fa-angle-left\'></i>","<i class=\'fa fa-angle-right\'></i>"]
                
                });
            
            });
        </script> ';
	    }     
	    $gigabyte_slide_markup .= '
	    			<div class="gigabyte-slide-wrapper" id="gigabyte-slide-carousel-'.esc_attr($gigabyte_slides_random_id).'">';
					    while($q->have_posts()) : $q->the_post();
					        $idd = get_the_ID();
					        $slide_meta = get_post_meta($idd, 'gigabyte_slide_options', true);
					        $post_content = get_the_content();


					        if(!empty($slide_meta['bg_image_upload'])){
                                    $slide_bg_img  = ''.$slide_meta['bg_image_upload'].'';    
                                                }elseif(!empty($slide_meta['bg_image_url'])){
                                     $slide_bg_img = ''.$slide_meta['bg_image_url'].'';               
                                                }else{
                                      $slide_bg_img = '';
                                            }
                            if(array_key_exists('enable_overley', $slide_meta)){
					            $enable_overley = $slide_meta['enable_overley'];
					        }else{
					            $enable_overley = true;
					        }
					        if(array_key_exists('overley_percentage', $slide_meta)){
					            $overley_percentage = $slide_meta['overley_percentage'];
					        }else{
					            $overley_percentage = .7;
					        }
					        if(array_key_exists('overley_color', $slide_meta)){
					            $overley_color = $slide_meta['overley_color'];
					        }else{
					            $overley_color = '#000';
					        }

		$gigabyte_slide_markup .= '
					<div class="single_slide_item" style="background-image:url('.$slide_bg_img.'); height:'.$height.'px; ">
					<div style="opacity: '.$overley_percentage.';  background: '.$overley_color.';" class="slide-overley"></div>
							<div class="slide-item-table">
								<div class="slide-item-tablecell">
									<div class="container">
										<div class="row">
											<div class="col-md-5 col-sm-6">
												<h2>'.esc_html(get_the_title($idd)).'</h2>
												'.wpautop($post_content, $idd).'';

												if(!empty($slide_meta['buttons'])){
									$gigabyte_slide_markup .='
													<div class="slide-buttons">';
														foreach ($slide_meta['buttons'] as $button) {
														if ($button['link_type'] == 1) {
														$btn_link = get_page_link($button['link_to_page']);
														}else{
															$btn_link = $button['external_link'];
														}
									$gigabyte_slide_markup .= 
											'<a href="'.esc_url($btn_link).'" class="'.$button['button_type'].'-btn giga-slide-btn">'.$button['link_text'].'</a>';		
																		}
									$gigabyte_slide_markup .='
													</div>';
																}


						$gigabyte_slide_markup .= '</div>'; 


						if(!empty($slide_meta['upload_image'])){
                        $image_location  = ''.$slide_meta['upload_image'].'';    
                                    }elseif(!empty($slide_meta['image_url'])){
                        $image_location = ''.$slide_meta['image_url'].'';               
                                    }else{
                        $image_location = '';
                                }
                                    
							$gigabyte_slide_markup .= '
                                    <img src="'.$image_location.'" alt="" class="hero-man">'; 
						$gigabyte_slide_markup .= '
											</div>
										</div>
									</div>
								</div>
					        </div>
								        ';        
						endwhile;
	    $gigabyte_slide_markup.= '
	    			</div>';
	    wp_reset_query();
	    return $gigabyte_slide_markup;
	}
	add_shortcode('gigabyte_slide', 'gigabyte_slide_shortcode');  
